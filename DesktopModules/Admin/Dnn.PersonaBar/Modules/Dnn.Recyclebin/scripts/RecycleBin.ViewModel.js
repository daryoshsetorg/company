define(["jquery","knockout","main/koBindingHandlers/toggle","main/koBindingHandlers/jScrollPane","main/koBindingHandlers/tabs","main/koBindingHandlers/setWhenHover","main/koBindingHandlers/setWidthFromParentScrollPaneWhen"],function(k,H){function x(e){var n=this;if(n.Id=e.Id,n.TabModuleId=e.TabModuleId,n.Title=e.Title,n.PortalId=e.PortalId,n.TabName=e.TabName,n.TabID=e.TabID,n.TabDeleted=e.TabDeleted,window.isRtl&&1900<moment(e.LastModifiedOnDate).format("YYYY"))try{moment.loadPersian(),n.LastModifiedOnDate=moment(e.LastModifiedOnDate,"MM/DD/YYYY hh:mm:ss a").format("jYYYY/jMM/jDD hh:mm:ss a"),n.friendlyLastModifiedOnDate=moment(e.friendlyLastModifiedOnDate,"MM/DD/YYYY hh:mm:ss a").format("jYYYY/jMM/jDD hh:mm:ss a")}catch(e){}else n.LastModifiedOnDate=e.LastModifiedOnDate,n.friendlyLastModifiedOnDate=e.friendlyLastModifiedOnDate;n.selected=H.observable(!1),n.mouseOver=H.observable(!1)}function G(e){var n=this;if(n.Id=e.Id,n.Username=e.Username,n.PortalId=e.PortalId,n.DisplayName=e.DisplayName,n.Email=e.Email,window.isRtl&&1900<moment(e.LastModifiedOnDate).format("YYYY"))try{moment.loadPersian(),n.LastModifiedOnDate=moment(e.LastModifiedOnDate,"MM/DD/YYYY hh:mm:ss a").format("jYYYY/jMM/jDD hh:mm:ss a"),n.friendlyLastModifiedOnDate=moment(e.friendlyLastModifiedOnDate,"MM/DD/YYYY hh:mm:ss a").format("jYYYY/jMM/jDD hh:mm:ss a")}catch(e){}else n.LastModifiedOnDate=e.LastModifiedOnDate,n.friendlyLastModifiedOnDate=e.friendlyLastModifiedOnDate;n.selected=H.observable(!1),n.mouseOver=H.observable(!1)}function W(e){var n,s,t,i,r,o,a=this;if(n=function(e){return e.parent?a.depth(1+n(e.parent)):a.depth(0),a.depth()},s=function(e){var n=0;return e&&0!==e.length?(e.forEach(function(e){n+=s(e.children())}),e.length+n):0},o=function(e){for(var n=0;n<e.length;n++){var t=e[n];if(!t.selected())return!0;if(o(t.children()))return!0}return!1},t=function(e,n){a.children&&e().forEach(function(e){e.selected(n)})},r=function(e,n){a.children&&e().forEach(function(e){e.even(n)})},i=function(e){return e.parent?i(e.parent):e.even()},a.id=e.id,a.name=e.name,a.childCount=e.childCount,a.url=e.url,a.publishDate=e.publishDate,a.status=e.status,a.parentId=e.parentId,a.level=e.level,a.tabpath=e.tabpath,a.isspecial=e.isspecial,a.useDefaultSkin=e.useDefaultSkin,window.isRtl&&1900<moment(e.lastModifiedOnDate).format("YYYY"))try{moment.loadPersian(),a.lastModifiedOnDate=moment(e.lastModifiedOnDate,"MM/DD/YYYY hh:mm:ss a").format("jYYYY/jMM/jDD hh:mm:ss a"),a.friendlyLastModifiedOnDate=moment(e.friendlyLastModifiedOnDate,"MM/DD/YYYY hh:mm:ss a").format("jYYYY/jMM/jDD hh:mm:ss a")}catch(e){}else a.lastModifiedOnDate=e.lastModifiedOnDate,a.friendlyLastModifiedOnDate=e.friendlyLastModifiedOnDate;a.even=H.observable(!1),a.even.extend({notify:"always"}),a.selected=H.observable(!1),a.selected.extend({notify:"always"}),a.mouseOver=H.observable(!1),a.depth=H.observable(0),a.parent=null,a.children=H.observableArray([]),a.numberOfNestedChildren=H.computed(function(){return 1+s(a.children())}),a.cellWidth=H.computed(function(){return 19*a.numberOfNestedChildren()+160}),a.totalHeight=H.computed(function(){var e,n;e=[];for(var t=0;t<a.children().length-1;t++)e.push(a.children()[t]);return 0===(n=s(e))?0:64*n+"px"}),a.isItsRootElementEven=H.computed(function(){return i(a)}),a.depthInPixels=H.computed(function(){return 50*a.depth()+"px"}),a.selected.subscribe(function(e){t(a.children,e)}),a.even.subscribe(function(e){r(a.children,e)}),a.calculateDepth=function(){n(a)},a.hasUnselectedChildren=function(){return o(a.children())}}return function(){"use strict";var r,o,a,n,l,d,c,t,s,u,i,f,e,m,h,v,g,p,b,M,y,L,D,Y,R,C,E,P,_,I,U,w,T,S,O,A,N={};function j(e,n,t,s,i){o=e,n,a=t,r=s,l={canViewPages:i.isHost||i.isAdmin||i.permissions.RECYCLEBIN_PAGES_VIEW,canViewModules:i.isHost||i.isAdmin||i.permissions.RECYCLEBIN_MODULES_VIEW,canViewUsers:i.isHost||i.isAdmin||i.permissions.RECYCLEBIN_USERS_VIEW,canManagePages:i.isHost||i.isAdmin||i.permissions.RECYCLEBIN_PAGES_EDIT,canManageModules:i.isHost||i.isAdmin||i.permissions.RECYCLEBIN_MODULES_EDIT,canManageUsers:i.isHost||i.isAdmin||i.permissions.RECYCLEBIN_USERS_EDIT,canEmptyRecycleBin:i.isHost||i.isAdmin||i.permissions.RECYCLEBIN_PAGES_VIEW&&i.permissions.RECYCLEBIN_PAGES_EDIT&&i.permissions.RECYCLEBIN_MODULES_VIEW&&i.permissions.RECYCLEBIN_MODULES_EDIT&&i.permissions.RECYCLEBIN_USERS_VIEW&&i.permissions.RECYCLEBIN_USERS_EDIT}}j.class="DnnPageRecycleBin",j.type="Class",e=function(e){e.selected(!e.selected())},c=function(e){var n=[];return e&&e.forEach(function(e){e.selected()&&n.push(e),e.children&&(n=n.concat(c(e.children())))}),n},t=function(e,n){e&&e.forEach(function(e){e.selected(n)})},s=function(e,n){if(e){var t=!1,s=O();e.forEach(function(e){e.TabDeleted?t=!0:e.selected(n)}),t&&s.selectAllModules()&&a.notifyError(o.recyclebin_UnableToSelectAllModules)}},m=function(){var e,n,t,s,i;l.canViewPages&&l.canManagePages&&(n=O(),0<(e=c(n.deletedpagesList())).length&&(t=1<e.length?o.recyclebin_RestorePagesConfirm:o.recyclebin_RestorePageConfirm,s=o.recyclebin_YesConfirm,i=o.recyclebin_NoConfirm,a.confirm(t,s,i,function(){S().post("RestorePage",e,v)})))},g=function(e){var n={value:!0,errors:""};return e.forEach(function(e){e.hasUnselectedChildren()&&(n.value=!1,n.errors+=o.Service_RemoveTabError.replace(/\{0\}/g,e.name))}),n},h=function(){var n,e,t,s,i;l.canViewPages&&l.canManagePages&&(e=O(),0<(n=c(e.deletedpagesList())).length&&(t=1<n.length?o.recyclebin_RemovePagesConfirm:o.recyclebin_RemovePageConfirm,s=o.recyclebin_YesConfirm,i=o.recyclebin_NoConfirm,a.confirm(t,s,i,function(){var e=g(n);e.value?S().post("RemovePage",n,v):a.notifyError(o.Service_RemoveTabErrorHeader+e.errors)})))},p=function(){var n,t,e,s,i;l.canViewModules&&l.canManageModules&&(n=O(),0<(t=c(n.deletedmodulesList())).length&&(e=1<t.length?o.recyclebin_RestoreModulesConfirm:o.recyclebin_RestoreModuleConfirm,s=o.recyclebin_YesConfirm,i=o.recyclebin_NoConfirm,a.confirm(e,s,i,function(){S().post("RestoreModule",t,function(){for(var e=0;e<t.length;e++)n.deletedmodulesList.remove(t[e]);n.selectAllModules(!1)})})))},b=function(){var n,t,e,s,i;l.canViewModules&&l.canManageModules&&(n=O(),0<(t=c(n.deletedmodulesList())).length&&(e=1<t.length?o.recyclebin_RemoveModulesConfirm:o.recyclebin_RemoveModuleConfirm,s=o.recyclebin_YesConfirm,i=o.recyclebin_NoConfirm,a.confirm(e,s,i,function(){S().post("RemoveModule",t,function(){for(var e=0;e<t.length;e++)n.deletedmodulesList.remove(t[e]);n.selectAllModules(!1)})})))},E=function(){var e,n,t,s,i;l.canViewUsers&&l.canManageUsers&&(n=O(),0<(e=c(n.deletedusersList())).length&&(t=1<e.length?o.recyclebin_RestoreUsersConfirm:o.recyclebin_RestoreUserConfirm,s=o.recyclebin_YesConfirm,i=o.recyclebin_NoConfirm,a.confirm(t,s,i,function(){S().post("RestoreUser",e,_)})))},P=function(){var n,t,e,s,i;l.canViewUsers&&l.canManageUsers&&(n=O(),0<(t=c(n.deletedusersList())).length&&(e=1<t.length?o.recyclebin_RemoveUsersConfirm:o.recyclebin_RemoveUserConfirm,s=o.recyclebin_YesConfirm,i=o.recyclebin_NoConfirm,a.confirm(e,s,i,function(){S().post("RemoveUser",t,function(){for(var e=0;e<t.length;e++)n.deletedusersList.remove(t[e]);n.selectAllUsers(!1)})})))},_=function(e){0<e.Status&&a.notifyError(e.Message),T(),k("#showsite").data("need-refresh",!0)},v=function(e){0<e.Status&&a.notifyError(e.Message),U(),k("#showsite").data("need-refresh",!0)},M=function(n){var e,t,s;l.canViewPages&&l.canManagePages&&(e=o.recyclebin_RestorePageConfirm,t=o.recyclebin_YesConfirm,s=o.recyclebin_NoConfirm,a.confirm(e,t,s,function(){var e=[];e.push({id:n.id}),S().post("RestorePage",e,v)}))},R=function(n){var e,t,s;l.canViewUsers&&l.canManageUsers&&(e=o.recyclebin_RestoreUserConfirm,t=o.recyclebin_YesConfirm,s=o.recyclebin_NoConfirm,a.confirm(e,t,s,function(){var e=[];e.push({id:n.Id}),S().post("RestoreUser",e,_)}))},y=function(n){var e,t,s;l.canViewPages&&l.canManagePages&&(e=o.recyclebin_RemovePageConfirm,t=o.recyclebin_YesConfirm,s=o.recyclebin_NoConfirm,a.confirm(e,t,s,function(){if(0<n.children().length)a.notifyError(o.Service_RemoveTabParentTabError.replace(/\{0\}/g,n.name));else{var e=[];e.push({id:n.id}),S().post("RemovePage",e,v)}}))},C=function(n){var t,e,s,i;l.canViewUsers&&l.canManageUsers&&(t=O(),e=o.recyclebin_RemoveUserConfirm,s=o.recyclebin_YesConfirm,i=o.recyclebin_NoConfirm,a.confirm(e,s,i,function(){var e=[];e.push({Id:n.Id}),S().post("RemoveUser",e,function(){t.deletedusersList.remove(n)})}))},L=function(n,e){var t,s,i,r;l.canViewModules&&l.canManageModules&&(t=O(),s=o.recyclebin_RestoreModuleConfirm,i=o.recyclebin_YesConfirm,r=o.recyclebin_NoConfirm,a.confirm(s,i,r,function(){var e=[];e.push({Id:n.Id,TabModuleId:n.TabModuleId,TabID:n.TabID}),S().post("RestoreModule",e,function(){t.deletedmodulesList.remove(n)})}))},D=function(n,e){var t,s,i,r;l.canViewModules&&l.canManageModules&&(t=O(),s=o.recyclebin_RemoveModuleConfirm,i=o.recyclebin_YesConfirm,r=o.recyclebin_NoConfirm,a.confirm(s,i,r,function(){var e=[];e.push({Id:n.Id,TabModuleId:n.TabModuleId,TabID:n.TabID}),S().post("RemoveModule",e,function(){t.deletedmodulesList.remove(n)})}))},Y=function(){if(l.canEmptyRecycleBin){var e=O(),n=o.recyclebin_EmptyRecycleBinConfirm,t=o.recyclebin_DeleteConfirm,s=o.recyclebin_CancelConfirm;a.confirm(n,t,s,function(){S().get("EmptyRecycleBin",{t:(new Date).getTime()},function(){e.deletedpagesList.removeAll(),e.deletedmodulesList.removeAll(),e.deletedusersList.removeAll()})})}},i=function(e){var n=!1;e.forEach(function(e){e.even(n),n=!n})},f=function(e){void 0!==e&&e.forEach(function(e){e.calculateDepth()})},u=function(e){var n,t,s;return n=[],t={},e.forEach(function(e){void 0!==(t[e.id]=e).parentId&&(s=t[e.parentId])?(s.children.push(e),e.parent=s):n.push(e)}),f(e),i(n),n};var V={},B=null;I=function(i,r,e){var n=k(e).jScrollPane(),o=n.data("jsp"),a=O(),t=1==V.hasOwnProperty(r);V[r]=t?V[r]:{modelName:r,paginationRequestCount:1};n.bind("jsp-scroll-y",function(e,n,t,s){B||0<n&&s&&!B&&0<V[r].remainingPages&&(B=setTimeout(function(){B=null},2e3),V[r].paginationRequestCount=V[r].paginationRequestCount||1,S().get(i,{pageIndex:V[r].paginationRequestCount++,pageSize:15},function(e){var n=e.Results,t=0<V[r].remainingPages-n.length,s=[];switch(V[r].remainingPages=t?V[r].remainingPages-n.length:0,r){case"deletedpagesList":n.forEach(function(e){var n=new W(e);s.push(n)}),u(s).forEach(function(e){a[r].push(e)});break;case"deletedusersList":n.forEach(function(e){var n=new G(e);a[r].push(n)});break;case"deletedtemplatesList":n.forEach(function(e){var n=new TemplateInfo(e);a[r].push(n)});break;case"deletedmodulesList":n.forEach(function(e){var n=new x(e);a[r].push(n)})}o.reinitialise(),o.scrollToPercentY(.95)}))})};return U=function(){var r,o;l.canViewPages&&(k("#pageList").jScrollPane().data("jsp").scrollToPercentY(0),r=[],(o=O()).deletedPagesReady(!1),o.deletedpagesList.removeAll(),S().get("GetDeletedPageList",{pageIndex:0,pageSize:15},function(e){var n=e.Results,t="deletedpagesList";V[t]={},V[t].remainingPages=e.TotalResults-15,V[t].moduleName=t;for(var s=0;s<n.length;s++){var i=new W(n[s]);r.push(i)}d=r.concat(),o.selectAllPages(!1),o.deletedpagesList(u(d)),o.deletedPagesReady(!0)}))},w=function(e){if(l.canViewModules){var r=O();if(("boolean"!=typeof e||"boolean"==typeof e&&!e)&&!r.deletedModulesReady())return;k("#moduleList").jScrollPane().data("jsp").scrollToPercentY(0),r.deletedModulesReady(!1),r.deletedmodulesList.removeAll(),S().get("GetDeletedModuleList",{pageIndex:0,pageSize:15},function(e){var n=e.Results,t="deletedmodulesList";V[t]={},V[t].remainingPages=e.TotalResults-15,V[t].paginationRequestCount=1,V[t].moduleName=t;for(var s=0;s<n.length;s++){var i=new x(n[s]);r.deletedmodulesList.push(i)}r.deletedModulesReady(!0)})}},T=function(e){if(l.canViewUsers){var r=O();if(("boolean"!=typeof e||"boolean"==typeof e&&!e)&&!r.deletedUsersReady())return;k("#userList").jScrollPane().data("jsp").scrollToPercentY(0),r.deletedUsersReady(!1),r.deletedusersList.removeAll(),S().get("GetDeletedUserList",{pageIndex:0,pageSize:15},function(e){var n=e.Results,t="deletedusersList";V[t]={},V[t].remainingPages=e.TotalResults-15,V[t].moduleName=t;for(var s=0;s<n.length;s++){var i=new G(n[s]);r.deletedusersList.push(i)}r.selectAllUsers(!1),r.deletedUsersReady(!0)})}},A=function(e,n){var t=0;switch(n.newPanel.attr("id")){case"pages":t=0;break;case"modules":t=1;break;case"users":t=2;break;default:t=0}O().activeTab(t)},O=function(){return n||(n={resx:o,settings:l,activeTab:H.observable(0),deletedPagesReady:H.observable(!1),deletedModulesReady:H.observable(!1),deletedUsersReady:H.observable(!1),deletedpagesList:H.observableArray([]),deletedmodulesList:H.observableArray([]),deletedusersList:H.observableArray([]),selectAllPages:H.observable(!1),selectAllModules:H.observable(!1),selectAllUsers:H.observable(!1),changeElementSelectedStatus:e,removePage:y,removeModule:D,removeUser:C,restorePage:M,restoreModule:L,restoreUser:R,restoreSelectedPages:m,restoreSelectedModules:p,restoreSelectedUsers:E,removeSelectedPages:h,removeSelectedModules:b,removeSelectedUsers:P,refreshPages:U,refreshModules:w,refreshUsers:T,emptyRecycleBin:Y,tabActivated:A},l.canViewPages&&l.canManagePages&&n.selectAllPages.subscribe(function(e){t(n.deletedpagesList(),e)}),l.canViewModules&&l.canManageModules&&n.selectAllModules.subscribe(function(e){s(n.deletedmodulesList(),e)}),l.canViewUsers&&l.canManageUsers&&n.selectAllUsers.subscribe(function(e){t(n.deletedusersList(),e)})),n},S=function(){return a.sf.moduleRoot="personaBar",a.sf.controller="Recyclebin",a.sf},j.prototype.init=function(e){r=k.extend({},N,r);var n=O();H.applyBindings(n,e[0]),[{apiMethod:"GetDeletedPageList",viewModelProp:"deletedpagesList",elementId:"#pageList"},{apiMethod:"GetDeletedUserList",viewModelProp:"deletedusersList",elementId:"#userList"},{apiMethod:"GetDeletedModuleList",viewModelProp:"deletedmodulesList",elementId:"#moduleList"},{apiMethod:"GetDeletedTemplates",viewModelProp:"deletedtemplatesList",elementId:"#templateList"}].forEach(function(e){I(e.apiMethod,e.viewModelProp,e.elementId)})},j.prototype.show=function(){U(),w(!0),T(!0)},j}()});